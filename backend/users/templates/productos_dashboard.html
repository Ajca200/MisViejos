{% extends 'base_dashboard.html' %}

{% load static %}

{% block title %}Gesti√≥n de Productos{% endblock %}

{% block link %}
<link rel="stylesheet" href="{% static 'css/dashboard_admin.css' %}">
{% endblock %}

{% block bootstrap %}
<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Encabezado -->
    <h2 class="mb-4">üì¶ Gesti√≥n de Productos y Categor√≠as</h2>

    <!-- Cards resumen -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-bg-primary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Productos Registrados</h5>
                    <p class="display-6 fw-bold">125</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-success shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Vendidos este mes</h5>
                    <p class="display-6 fw-bold">420</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-warning shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Stock bajo</h5>
                    <p class="display-6 fw-bold">8</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°fica de productos m√°s vendidos -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">üìä Productos m√°s vendidos</h5>
                    <canvas id="chartProductos" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Categor√≠as -->
    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">üìÇ Categor√≠as registradas</h5>
                    <table class="table table-striped align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dummy, luego vendr√°n de Django -->
                            {% if categorias %}
                                {% for categoria in categorias %}
                                    <tr>
                                        <td>{{ categoria.res_id }}</td>
                                        <td>{{ categoria.res_nombre }}</td>
                                        <td>{{ categoria.res_descripcion }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalEditarCategoria">Editar</button>
                                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalEliminarCategoria">Eliminar</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td>No se encuentran categorias registradas</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarCategoria">
                        ‚ûï Agregar Categor√≠a
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Productos -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">üìã Listado de productos</h5>
                    <table class="table table-striped align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Categor√≠a</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dummy, luego vendr√°n de Django -->
                            {% if productos %}
                                {% for producto in productos %}
                                    <tr>
                                        <td>{{ producto.res_id }}</td>
                                        <td>{{ producto.res_nombre }}</td>
                                        <td>$ {{ producto.res_precio }}</td>
                                        <td>{{ producto.res_stock }}</td>
                                        <td>{{ producto.res_categoria }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary btnEditarProducto" data-bs-toggle="modal" data-bs-target="#modalEditarProducto" 
                                            data-id="{{ producto.res_id }}" data-nombre="{{ producto.res_nombre }}" data-descripcion="{{producto.res_descripcion}}" data-precio="{{ producto.res_precio }}" data-cat_id="{{ producto.res_categoria_id }}" data-stock="{{ producto.res_stock }}">Editar</button>
                                            
                                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalEliminarProducto">Eliminar</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td>No se encuentran productos registrados</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">‚ûï Agregar Producto</button>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- ================= MODALS CATEGOR√çAS ================= -->

<!-- Modal Agregar Categor√≠a -->
<div class="modal fade" id="modalAgregarCategoria" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚ûï Agregar Categor√≠a</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formAgregarCategoria">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-control" name="descripcion"></textarea>
          </div>
          <button type="submit" class="btn btn-success w-100">Guardar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Categor√≠a -->
<div class="modal fade" id="modalEditarCategoria" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚úèÔ∏è Editar Categor√≠a</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarCategoria">
          <input type="hidden" name="cat_id">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-control" name="descripcion"></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">Actualizar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eliminar Categor√≠a -->
<div class="modal fade" id="modalEliminarCategoria" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">üóëÔ∏è Eliminar Categor√≠a</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de que deseas eliminar esta categor√≠a?</p>
        <form id="formEliminarCategoria">
          <input type="hidden" name="cat_id">
          <button type="submit" class="btn btn-danger w-100">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ================= MODALS PRODUCTOS ================= -->

<!-- Modal Agregar Producto -->
<div class="modal fade" id="modalAgregarProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚ûï Agregar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formAgregarProducto" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" name="nombre" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" name="cat_id" required>
                <option selected disabled>Seleccione una categor√≠a</option>
                {% if categorias %}
                    {% for categoria in categorias %}
                        <option value="{{ categoria.res_id }}">{{ categoria.res_nombre }}</option>
                    {% endfor %}
                {% else %}
                    <option>No hay categorias registradas</option>
                {% endif %}
                <!-- Opciones din√°micas desde Django -->
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-control" name="descripcion"></textarea>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Precio</label>
              <input type="number" step="0.01" class="form-control" name="precio" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Stock</label>
              <input type="number" class="form-control" name="stock" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Imagen</label>
              <input type="file" class="form-control" name="imagen" accept="image/*">
            </div>
          </div>
          <button type="submit" class="btn btn-success w-100">Guardar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Producto -->
<div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚úèÔ∏è Editar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarProducto" enctype="multipart/form-data">
          <input type="hidden" name="prod_id">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" name="nombre" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Categor√≠a</label>
              <select class="form-select" name="cat_id" required>
                <!-- Opciones din√°micas -->
                 {% if categorias %}
                    {% for categoria in categorias %}
                        <option value="{{ categoria.res_id }}">{{ categoria.res_nombre }}</option>
                    {% endfor %}
                {% else %}
                    <option>No hay categorias registradas</option>
                {% endif %}
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-control" name="descripcion"></textarea>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Precio</label>
              <input type="number" step="0.01" class="form-control" name="precio" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Stock</label>
              <input type="number" class="form-control" name="stock" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Imagen</label>
              <input type="file" class="form-control" name="imagen" accept="image/*">
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Actualizar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eliminar Producto -->
<div class="modal fade" id="modalEliminarProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">üóëÔ∏è Eliminar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de que deseas eliminar este producto?</p>
        <form id="formEliminarProducto">
          <input type="hidden" name="prod_id">
          <button type="submit" class="btn btn-danger w-100">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const menu = document.querySelector('.menu');
    menu.children[1].classList.add('active');
    
    const ctx = document.getElementById('chartProductos').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Vino Tinto', 'Ron A√±ejo', 'Cerveza Artesanal', 'Whisky Premium'],
            datasets: [{
                label: 'Unidades vendidas',
                data: [150, 100, 80, 50],
                backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
</script>
<script>
const formAddProduct = document.getElementById('formAgregarProducto');

formAddProduct.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Obtener los valores del formulario
    const nombre = formAddProduct.nombre.value.trim();
    const cat_id = formAddProduct.cat_id.value;
    const descripcion = formAddProduct.descripcion.value.trim();
    const precio = formAddProduct.precio.value;
    const stock = formAddProduct.stock.value;
    const imagen = formAddProduct.imagen.files[0];

    // ==== VALIDACIONES ====
    if (!nombre) {
        alert("‚ö†Ô∏è El nombre del producto es obligatorio.");
        return;
    }

    if (!cat_id || cat_id === "Seleccione una categor√≠a") {
        alert("‚ö†Ô∏è Debe seleccionar una categor√≠a.");
        return;
    }

    if (!precio || isNaN(precio) || Number(precio) <= 0) {
        alert("‚ö†Ô∏è El precio debe ser un n√∫mero v√°lido mayor que 0.");
        return;
    }

    if (!stock || isNaN(stock) || Number(stock) < 0) {
        alert("‚ö†Ô∏è El stock debe ser un n√∫mero v√°lido mayor o igual a 0.");
        return;
    }

    if (imagen) {
        const allowedTypes = ["image/jpeg", "image/png"];
        if (!allowedTypes.includes(imagen.type)) {
            alert("‚ö†Ô∏è La imagen debe estar en formato JPG o PNG.");
            return;
        }
    }

    // ==== PREPARAR FORM DATA ====
    const formData = new FormData();
    formData.append("nombre", nombre);
    formData.append("cat_id", cat_id);
    formData.append("descripcion", descripcion);
    formData.append("precio", precio);
    formData.append("stock", stock);
    if (imagen) formData.append("imagen", imagen);

    try {
        const response = await fetch("http://127.0.0.1:8000/users/products/register", {
            method: "POST",
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            alert("‚úÖ Producto registrado correctamente.");
            formAddProduct.reset();
            // Opcional: cerrar modal despu√©s de guardar
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarProducto'));
            modal.hide();
        } else {
            const errorData = await response.json();
            alert("‚ùå Error al registrar el producto: " + (errorData.detail || "Verifique los datos."));
        }
    } catch (error) {
        console.error("Error en la solicitud:", error);
        alert("‚ùå Ocurri√≥ un error al conectar con el servidor.");
    }
});
</script>

<!-- logica para modalActualizarProducto -->
 <script>
const formEditProduct = document.getElementById('formEditarProducto');

formEditProduct.addEventListener('submit', async (e) => {
    e.preventDefault();

    // === OBTENER VALORES DEL FORM ===
    const prod_id = formEditProduct.prod_id.value;
    const nombre = formEditProduct.nombre.value.trim();
    const descripcion = formEditProduct.descripcion.value.trim();
    const cat_id = formEditProduct.cat_id.value;
    const precio = formEditProduct.precio.value;
    const stock = formEditProduct.stock.value;
    const imagen = formEditProduct.imagen.files[0];
    console.log(prod_id)
    // === VALIDACIONES ===
    if (!prod_id) {
        alert("‚ö†Ô∏è No se encontr√≥ el ID del producto.");
        return;
    }
    if (!nombre) {
        alert("‚ö†Ô∏è El nombre es obligatorio.");
        return;
    }
    if (!cat_id) {
        alert("‚ö†Ô∏è Debe seleccionar una categor√≠a.");
        return;
    }
    if (!precio || isNaN(precio) || Number(precio) <= 0) {
        alert("‚ö†Ô∏è Precio inv√°lido.");
        return;
    }
    if (!stock || isNaN(stock) || Number(stock) < 0) {
        alert("‚ö†Ô∏è Stock inv√°lido.");
        return;
    }
    if (imagen) {
        const allowedTypes = ["image/jpeg", "image/png"];
        if (!allowedTypes.includes(imagen.type)) {
            alert("‚ö†Ô∏è Solo se permiten im√°genes JPG o PNG.");
            return;
        }
    }

    // === FORM DATA ===
    const formData = new FormData();
    formData.append("prod_id", prod_id);
    formData.append("nombre", nombre);
    formData.append("descripcion", descripcion);
    formData.append("cat_id", cat_id);
    formData.append("precio", precio);
    formData.append("stock", stock);
    if (imagen) formData.append("imagen", imagen);

    try {
        const response = await fetch("http://127.0.0.1:8000/users/products/actualizar", {
            method: "PUT", // cambiamos a PUT
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            alert("‚úÖ Producto actualizado correctamente.");
            formEditProduct.reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarProducto'));
            modal.hide();
        } else {
            const errorData = await response.json();
            alert("‚ùå Error al actualizar: " + (errorData.detail || "Revise los datos."));
        }
    } catch (error) {
        console.error(error);
        alert("‚ùå Error de conexi√≥n con el servidor.");
    }
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('.btnEditarProducto').forEach(button => {
            button.addEventListener('click', () => {
                const form = document.getElementById("formEditarProducto")

                form.prod_id.value = button.dataset.id;
                form.nombre.value = button.dataset.nombre;
                form.descripcion.value = button.dataset.descripcion;
                form.cat_id.value = button.dataset.cat_id;
                form.precio.value = button.dataset.precio;
                form.stock.value = button.dataset.stock;
            })
        })
    })

    
</script>

{% endblock %}
